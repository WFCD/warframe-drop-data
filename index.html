<!doctype html>
<title>Warframe Drop Data</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="shortcut icon" href="misc/logo.png" />

<meta property="og:title" content="Warframe Drop Data" />
<meta property="og:description" content="A tool/api to search through Digital Extremes official Warframe drop data website." />
<meta property="og:url" content="http://drops.warframestat.us" />
<meta property="og:image" content="http://drops.warframestat.us/misc/logo.png" />

<link rel="search" href="/opensearch.xml" type="application/opensearchdescription+xml" title="Warframe Drop Data"/>

<link rel="dns-prefetch" href="//fonts.googleapis.com" />
<link rel="dns-prefetch" href="//cdnjs.cloudflare.com" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Raleway:400,300,600" type="text/css" />
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css" />
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

<style>
    #no-script, #loading, #data-error {
        position: absolute;
        padding: 10px;

        top: 0;
        left: 0;
        right: 0;
        bottom: 0;

        background-color: white;
        opacity: 0.8;
        font-size: 3rem;

        justify-content: space-around;
        align-items: center;
        text-align: center;

        z-index: 9999;
    }

    #no-script i, #loading i, #data-error i {
        font-size: 9rem;
        margin-bottom: 25px;
    }

    .header {
        text-align: center;
    }

    .searchfield {
        width: 300px;
        margin-top: 50px;
    }

    .content {
        margin-bottom: 3em;
    }

    th {
        cursor: pointer;
        min-width: 75px;
    }

    th i {
        float: right;
        line-height: 1.4 !important;
    }

    td.msg {
        text-align: center;
    }

    .footer {
        position: fixed;

        bottom: 0;
        left: 0;
        right: 0;

        padding: 3px;

        background: white;
        color: #555;

        font-size: 12px;

        text-align: center;
    }

    .footer a {
        color: #555;
        text-decoration: none;
        font-weight: bolder;

        transition: color 0.5s ease;
    }

    .footer a:hover {
        color: #0099FF;
    }

    #last-update {
        font-weight: bolder;
    }

    #just-updated {
        color: #0099FF;
    }
</style>

<div id="no-script" style="display: flex;">
    <p>
        <i class="fa fa-warning" aria-hidden="true"></i><br />
        This website requires JavaScript.
    </p>
</div>

<div id="loading" style="display: none;">
    <p>
        <i class="fa fa-refresh fa-spin" aria-hidden="true"></i><br />
        Loading, please wait...
    </p>
</div>

<div id="data-error" style="display: none;">
    <p>
        <i class="fa fa-exclamation-circle" aria-hidden="true"></i><br />
        Could not load data, please refresh the page.
    </p>
</div>

<section>
    <div class="container">
        <div class="header">
            <div>
                <img src="misc/logo.png" height="64">
                <h5>Warframe Drop Data</h5>
                <a href="./diff.html">Compare Versions</a> | <a target="_blank" href="https://github.com/WFCD/warframe-drop-data#api-endpoints">API Documentation</a> | <a target="_blank" href="https://github.com/WFCD/warframe-drop-data">Github</a>
            </div>

            <div>
                <input class="searchfield" placeholder="Search here..." id="search-field" type="text" autofocus="autofocus" />
                <select id="search-type">
                    <option value="items">Items only</option>
                    <option value="locations">Locations only</option>
                    <option value="both">Items and locations</option>
                </select> 
                <select id="display-amount">
                    <option value="100">Show 100 items</option>
                    <option value="250">Show 250 items</option>
                    <option value="500">Show 500 items</option>
                    <option value="1000">Show 1000 items</option>
                    <option value="clem">Show all items</option>
                </select>
            </div>
        </div>

        <div class="content">
            <table class="u-full-width">
                <tbody id="tablebody">
                    <tr><td class="msg">Type what you're looking for into the search bar above!</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</section>

<footer class="footer">
    <b>NOTE</b>: This data is parsed from <a href="https://n8k6e2y6.ssl.hwcdn.net/repos/hnfvc0o3jnfvc873njb03enrf56.html" target="_blank">Digital Extremes' official drop data website</a>, no data mining was involved.
    Last update: <span id="last-update">Unknown</span> <span id="just-updated" title="Drop information has been updated since your last visit." style="display: none;"><i class="fa fa-asterisk"></i></span>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
    $("#no-script").hide()
    $("#loading").css('display', 'flex')

    const SCRIPT_VERSION = 14

    function fill(data, sort, reverse, amount) {
        $("#tablebody").empty()

        if (data.length === 0) {
            $("#tablebody").append("<tr><td class='msg'>Nothing found that matches your search query.</td></tr>")
            return
        }

        data = data.sort(function(a, b) {
            if (sort === 'item')        { return a.item.localeCompare(b.item) || b.chance - a.chance || a.place.localeCompare(b.place) }
            else if (sort === 'place')  { return a.place.localeCompare(b.place) || b.chance - a.chance || a.item.localeCompare(b.item) }
            else                        { return b.chance - a.chance || a.place.localeCompare(b.place) || a.item.localeCompare(b.item) }
        })

        if (reverse) { data.reverse() }

        const itemIcon = sort === 'item' ? `<i class="fa fa-sort-alpha-${ reverse ? 'desc' : 'asc' }"></i>` : ''
        const placeIcon = sort === 'place' ? `<i class="fa fa-sort-alpha-${ reverse ? 'desc' : 'asc' }"></i>` : ''
        const rarityIcon = sort === 'rarity' ? `<i class="fa fa-sort-amount-${ reverse ? 'asc' : 'desc' }"></i>` : ''

        $("#tablebody").append(`<tr>
            <th id="item">Item Name ${itemIcon}</th>
            <th id="place">Drops ${placeIcon}</th>
            <th id="rarity">Rarity ${rarityIcon}</th>
        </tr>`)

        if (!isNaN(amount) && data.length > amount) {
            for (let i = 0; i < amount; i++) {
                $("#tablebody").append(`<tr>
                    <td>${data[i].item}</td>
                    <td>${data[i].place}</td>
                    <td>${data[i].rarity} (<b>${data[i].chance}%</b>)</td>
                </tr>`)
            }

            $("#tablebody").append(`<tr><td class="msg" colspan="3"><strong>${data.length - amount}</strong> more results found. Refine your query to see more relevant results.</td></tr>`)
        } else {
            for (const obj of data) {
                $("#tablebody").append(`<tr>
                    <td>${obj.item}</td>
                    <td>${obj.place}</td>
                    <td>${obj.rarity} (<b>${obj.chance}%</b>)</td>
                </tr>`)
            }
        }

        $("th").on("click", function() {
            if (this.id) { fill(data, this.id, sort === this.id ? !reverse : false, amount) }
        })
    }

    function search(searchValue) {
        if (searchValue.length < 2) {
            window.location.hash = ''

            $("#tablebody").empty()
            $("#tablebody").append("<tr><td class='msg'>You have to type in at least 2 characters to search.</td></tr>")
            return
        }

        const searchArray = searchValue.split(' ').filter(item => item.length > 1)
        const type = $('#search-type').val()
        const amount = $('#display-amount').val()
        let items = []

        // Setup the search regex.
        let regex = ''
        for (const searchTerm of searchArray) {
            regex += `(?=.*\\b.*${searchTerm}.*\\b)`
        }
        regex = RegExp(regex, 'gi')

        window.location.hash = `/search/${encodeURIComponent(searchValue)}/${type}`

        if (type === 'items')           { items = items.concat(window._data.filter(entry => regex.test(entry.item))) }
        else if (type === 'locations')  { items = items.concat(window._data.filter(entry => regex.test(entry.place))) }
        else if (type === 'both')       { items = items.concat(window._data.filter(entry => regex.test(entry.item) || regex.test(entry.place))) }
        else                            { items = items.concat(window._data.filter(entry => regex.test(entry.item))) }

        fill(items, 'rarity', false, amount)
    }

    function onDataRetrieved(data) {
        window._data = data

        const info = JSON.parse(localStorage.getItem("_wfinfo"))
        const date = new Date(info.modified)

        $("#last-update").text(date.toLocaleString())

        const query = window.location.hash.split('/')

        if (query && query.length > 2 && query[1] === 'search') {
            if (query.length > 3 && query[3].match(/(items|locations|both)/)) {
                $("#search-field").val(decodeURIComponent(query[2]))
                $("#search-type").val(decodeURIComponent(query[3]))
            } else {
                $("#search-field").val(decodeURIComponent(query[2]))
                $("#search-type").val(decodeURIComponent('items'))
            }
        }

        const searchFieldValue = $("#search-field").val()

        if (searchFieldValue) {
            search(searchFieldValue)
        }

        $("#loading").remove()
    }

    function onDataError() {
        localStorage.clear()

        $("#no-script").hide()
        $("#loading").hide()
        $("#data-error").css('display', 'flex')
    }

    function updateData() {
        const time = new Date().getTime()

        if (localStorage.getItem("_wfdata") === null || Number(localStorage.getItem("_version") || -1) < SCRIPT_VERSION) {
            localStorage.clear()
        }

        localStorage.setItem("_version", SCRIPT_VERSION)

        $.getJSON(`./data/info.json?${time}`, function(info) {
            const oldInfo = JSON.parse(localStorage.getItem("_wfinfo") || "{\"hash\":\"clem\"}")

            if (info.hash !== oldInfo.hash) {
                localStorage.setItem("_wfinfo", JSON.stringify(info))

                $.getJSON(`./data/all.slim.json?${time}`, function(data) {
                    localStorage.setItem("_wfdata", JSON.stringify(data))

                    $('#just-updated').show()
                    onDataRetrieved(data)
                }).fail(onDataError)
            } else {
                onDataRetrieved(JSON.parse(localStorage.getItem("_wfdata")))
            }
        }).fail(onDataError)
    }

    $(document).ready(function() {
        updateData()

        let typingTimer

        $("#search-field").on("keyup", function() {
            // Wait a little before searching to improve performance.
            clearTimeout(typingTimer)
            typingTimer = setTimeout(function() {
                search($("#search-field").val().trim().replace(/\s+/g, ' '))
            }, 400)
        })

        $("#search-type, #display-amount").on("change", function() {
            search($("#search-field").val().trim().replace(/\s+/g, ' '))
        })
    })
</script>
